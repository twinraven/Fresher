var App=angular.module("Fresht",["ngRoute"]);App.controller("compareCtrl",["$scope","$location","$q","moviesService","stateService",function(e,t,i,r,o){"use strict";var n=this,c=t.search();c&&c.movie1&&c.movie2&&(o.setAllLoadingState(),i.all([r.getMovieDataById(c.movie1),r.getMovieDataById(c.movie2)]).then(function(e){n.movies[0]=e[0],n.movies[1]=e[1],o.clearAllLoadingState()},function(e){console.log(e)})),n.closeOverlay=function(){o.clearAllLoadingState(),o.setSearchState(!1),o.setMoreState(!1)},n.getMovieAtPos=r.getMovieAtPos,n.movies=r.getMovies(),n.state=o.getState()}]),App.controller("headerCtrl",["moviesService","stateService",function(e,t){"use strict";this.reset=function(){e.clearMovies(),e.clearUrlParams(),t.setMoreState(!1),t.setSearchState(!1),t.clearAllLoadingState()}}]),App.controller("searchCtrl",["$scope","$timeout","moviesService","stateService",function(e,t,i,r){"use strict";var o=this;o.results=null,o.clear=function(){o.results=null,o.title=""},o.start=function(){if(o.title){var e=i.search(o.title);e.success(function(e){o.results=e.movies}).error(function(){console.log("error")})}},o.use=function(e){i.save(o.results[e],o.state.searchActiveId)&&o.close()},o.close=function(){r.clearAllLoadingState(),r.setSearchState(!1),o.clear()},o.state=r.getState()}]),App.directive("addMovie",["stateService",function(e){"use strict";return{restrict:"E",replace:"true",scope:{movie:"=",id:"@"},bindToController:!0,templateUrl:"partials/add-movie.html",link:function(t,i,r){t.add=function(){e.setSearchState(!0,t.id),e.setLoadingState(t.id,!0)}}}}]),App.directive("hasFocusWhen",[function(){"use strict";return{restrict:"A",scope:{when:"=hasFocusWhen"},link:function(e,t,i){e.$watch("when",function(e,i){e!==!0||i||t[0].focus()})}}}]),App.directive("movieFull",["moviesService","stateService",function(e,t){"use strict";return{restrict:"E",replace:"true",scope:!0,templateUrl:"partials/movie-full.html",link:function(i,r,o){i.movie={},i.close=function(){t.setMoreState(!1)},i.$watch(t.getState,function(t,r){t&&t.activeMovie&&(i.movie=e.getCachedMovieDataById(t.activeMovie))},!0)}}}]),App.directive("movieTile",["moviesService","stateService",function(e,t){"use strict";return{restrict:"E",replace:"true",scope:{movie:"="},templateUrl:"partials/movie-tile.html",link:function(i,r,o){i.more=function(){t.setMoreState(!0),t.setActiveMovie(i.movie.id)},i.remove=function(t){e.remove(t),e.clearUrlParams()}}}}]),App.filter("prettyTime",function(){"use strict";return function(e){if(void 0===e||0===e.length)return e;e=Number(e);var t=Math.floor(e/60),i=60*t,r=Math.round(e-i);return t+" hr. "+r+" min."}}),App.config(["$routeProvider",function(e){"use strict";e.when("/",{templateUrl:"partials/main.html",reloadOnSearch:!1}),e.otherwise({redirectTo:"/"})}]),App.service("moviesService",["$http","$location","stateService",function(e,t,i){"use strict";var r=[],o={},n="http://api.rottentomatoes.com/api/public/v1.0/movies/%ID%.json?apikey=%APIKEY%&callback=JSONP_CALLBACK";return o.getMovies=function(){return r},o.getMovieAtPos=function(e){return r[0]&&r[0].pos==e?r[0]:r[1]&&r[1].pos==e?r[1]:null},o.clearMovies=function(){r.length=0},o.isMovieCached=function(e){var t=_.filter(r,function(t){return t.id===e});return t.length},o.save=function(e,t){var i;return o.isMovieCached(e.id)?(alert("this movie is already in your comparison.\nPlease choose another"),!1):(r.length<2?(o.clearBestMovie(),null!==t&&void 0!==t&&(i=t),e.pos=i,r[r.length]=e,2===r.length&&(o.addComparisonToUrl(),o.highlightBestMovie())):alert("you already have 2 movies. Please remove 1 first"),!0)},o.addComparisonToUrl=function(){t.search({movie1:r[0].id,movie2:r[1].id})},o.highlightBestMovie=function(){var e=null;r[0].ratings.critics_score>r[1].ratings.critics_score&&(e=0),r[0].ratings.critics_score<r[1].ratings.critics_score&&(e=1),null!==e&&i.setBestMovie(parseInt(r[e].pos,10))},o.clearBestMovie=function(){i.clearBestMovie()},o.clearUrlParams=function(){t.search({})},o.remove=function(e){var t=-1;_.find(r,function(i,r){i.id===e&&(t=r)}),-1!==t&&r.splice(t,1)},o.getSearchUrl=function(e){return"json/search.json"},o.getMovieUrl=function(e){return n.replace(/%ID%/,e).replace(/%APIKEY%/,APIKEY)},o.search=function(t){var i=o.getSearchUrl(t);return e.get(i)},o.getCachedMovieDataById=function(e){return _.find(r,function(t){return t.id===e})},o.getMovieDataById=function(t){var i=o.getMovieUrl(t);return e.jsonp(i)},o}]),App.service("stateService",[function(){"use strict";var e={},t={searchActive:!1,searchActiveId:null,moreActive:!1,activeMovie:null,bestMovie:null,loading:[!1,!1]};return e.getState=function(){return t},e.setSearchState=function(e,i){t.searchActive=e,t.searchActiveId=i||null},e.setMoreState=function(e){t.moreActive=e},e.setActiveMovie=function(e){t.activeMovie=e},e.setLoadingState=function(e,i){t.loading[e]=i},e.setAllLoadingState=function(){e.setLoadingState(0,!0),e.setLoadingState(1,!0)},e.clearAllLoadingState=function(){e.setLoadingState(0,!1),e.setLoadingState(1,!1)},e.setBestMovie=function(e){t.bestMovie=e},e.clearBestMovie=function(){t.bestMovie=null},e}]);